
#### What is Malware?

Malware refers to any software intentionally designed to cause harm to a computer, server, network, or user.

#### What is a Virus?

A computer virus is a self-replicating program that spreads without the owner's permission or knowledge. Unlike worms that exploit vulnerabilities, viruses rely on the host for propagation. If a file carrying a virus is moved to another system, the virus has an opportunity to spread and survive.

**Sub-Types of Viruses:**

1. **Resident:** Executes and becomes memory resident, infecting other programs when triggered by specific events.
2. **Non-Resident:** Searches for files to infect upon execution, quits afterward, and continues to find new targets when the infected program runs again.
3. **Boot Sector:** Spreads via boot sectors, for example, when an infected CD-ROM is left in the drive during system shutdown, activating and spreading upon the next boot.
4. **Multi-Partite:** Exhibits various infection mechanisms, combining features like Boot-Sector and Resident viruses for versatile spreading.

#### What is a Worm?

Worms are a type of software that exploits network or system vulnerabilities to autonomously spread from one system to another.

#### What is a Rootkit?

A rootkit is a type of stealthy malware designed to conceal or compromise a computer system at a deep level. Functioning as a complement to other malicious software, rootkits can hide processes, add files to the file system, implement backdoors, and create vulnerabilities.

**Types of Rootkits:**

- **Application Level:** Replaces programs with copies of others.
- **Library Level:** Controls shared libraries, affecting multiple applications.
- **Kernel Level:** Common and resistant to removal, operates at the same privilege level as antivirus software.
- **Hypervisor Level:** Utilizes virtualization technologies, such as Blue Pill and SubVirt.
- **Firmware Level:** Targets firmware like BIOS, ACPI tables, and device ROMs, with a high chance of survival due to limited scanning tools.

#### What is a Bootkit?

Bootkits differ from rootkits by infiltrating the operating system before it fully starts, compromising security from the outset. This unique approach grants bootkits the ability to exert complete control over the target operating system.

#### What is a Trojan?

A Trojan masquerades as legitimate software while secretly enabling unauthorized access to the user's system. An example is downloading a game from the internet, which may contain hidden malicious code. While the user enjoys the game, the concealed code executes malicious activities in the background.

#### What is a Backdoor?

A backdoor is software enabling unauthorized access by bypassing authentication. It allows remote entry while remaining hidden, similar to Remote Access Trojans (RATs).

#### What is Spyware?

Spyware gathers user information, monitoring online activities without consent. The collected data is sent to the spyware's author.

#### What is a Botnet?

Botnets are networks of compromised computers controlled by a central server. Created through malware installation, they can be used for DDoS attacks and spam distribution by the bot master, who issues commands to the bots.

#### What is Ransomware?

Ransomware encrypts files and demands payment in Bitcoin for the decryption key. It holds files hostage, requiring victims to pay a ransom to restore their data, earning the name extortive malware.

#### What is an Information Stealer?

Information stealers illicitly acquire sensitive data like encryption keys, login credentials, credit card information, and proprietary data. The stolen data may be exploited for various malicious purposes.

#### What is a Keylogger?

Keyloggers capture keystrokes as the victim types.

#### What is a Screen Recorder?

Screen recorders are malicious software designed to capture and record screenshots of the active window on a victim's computer.

#### What is a RAM Scraper?

RAM scrapers are malware designed to extract sensitive data, including login credentials, from a computer's random access memory (RAM).

#### Other Types of Malware:

- **Adware:** Displays unwanted ads.
- **Greyware:** Causes undesired effects.
- **Scareware:** Tricks users with false threats.
- **Fakeware:** Deceives as legitimate software.
- **PUPs (Potentially Unwanted Programs):** Bundled with downloads.

### Malware Delivery

These are common vectors for malware distribution:

1. **Physical Media:** Malware spread through CDs, USB drives, etc.
2. **Email (Attachments):** Malicious software attached to emails.
3. **URL Links:** Malicious links leading to malware downloads.
4. **Drive-by Downloads:** Malware automatically downloaded from websites.
5. **Web Advertising:** Malicious ads containing malware.
6. **Social Media:** Malware spread through social platforms.
7. **File Shares:** Malware distributed through shared files.
8. **Software Vulnerabilities:** Exploiting weaknesses in software for malware delivery.

**Exploitation Techniques:**

1. **Stack Overflows:** Exploited by overflowing stack buffers to control the flow of execution and execute malicious code.
2. **Heap Overflows:** Exploited by overwriting heap pointers to direct the execution to malicious code instead of its original location.

**Additional Vectors:**

1. **Peer-to-Peer (P2P) File Sharing**
2. **Instant Messaging**

### Malware Evasion Techniques

Malware employs various techniques to run, evade detection, and achieve its objectives, including privilege escalation, credential theft, data exfiltration, and persistence. Researchers and adversaries continuously discover new evasion methods. Staying informed about the latest techniques is essential for cybersecurity professionals.

**MITRE ATT&CK Resources:**

- [Exfiltration](https://attack.mitre.org/wiki/Exfiltration)
- [Persistence](https://attack.mitre.org/wiki/Persistence)
- [Technique Matrix](https://attack.mitre.org/wiki/Technique_Matrix)

One technique involves leveraging Alternate Data Streams (ADS), a feature of the NTFS file system. ADS can store metadata and other data streams, providing a covert method for concealing information within files. Understanding such evasion techniques is vital for effective threat hunting and cybersecurity.

**Injection Techniques:**

1. **DLL Injection:**
    
    - **Locate Process:** Malware finds a target process using Windows API.
    - **Open Process:** The malware opens the identified process.
    - **Allocate Memory:** Finds a location to write the path of the malicious DLL.
    - **Copy:** Writes the path to the malicious DLL into the allocated memory.
    - **Execute:** Executes the malicious DLL in another process by starting a new thread.
2. **Reflective DLL Injection:** A stealthier technique that loads the DLL in memory without relying on standard Windows API calls. The DLL maps itself into memory, resolving import addresses, fixing relocations, and calling DllMain without using LoadLibrary.
    
3. **Thread Hijacking:**
    
    - **Locate Thread:** Malware finds a target thread to inject into.
    - **Open Thread:** Opens the identified thread.
    - **Suspend Thread:** Suspends the thread to inject.
    - **Allocate Memory:** Finds a location to write the path of the malicious DLL or shellcode.
    - **Copy:** Writes the path to the malicious DLL or shellcode into the allocated memory.
    - **Resume Thread:** Resumes the thread after injection.
4. **PE (Portable Executable) Injection:** Similar to DLL Injection but doesn't require the malicious DLL to reside on disk. Uses WriteProcessMemory to write the malicious code into the target location without using LoadLibrary.
    

**Hooking Events:**

- **Interception:** Malware intercepts events with SetWindowsHookEx().
- **Monitoring:** Monitors keyboard and mouse inputs, among others.
- **DLL Loading:** Loads malicious DLLs based on specific events.
- **Significance:** Enables covert actions like keylogging and executing additional payloads.

**Kernel-Mode Rootkits: SSDT Hooks Overview:**

1. **SSDT Basics:**
    - SSDT (System Service Descriptor Table) aids Windows Kernel.
    - Entries point to essential kernel mode functions.
2. **Kernel Mode Operations:**
    - Kernel functions correspond to SSDT entries.
    - SSDT exported as KeServiceDescriptorTable().
3. **SSDT Hooking:**
    - Globally modify SSDT pointers.
    - Redirect system functions to rootkit-controlled location.
4. **Implementation:**
    - **Hook SSDT Entry:** Redirect specific function (e.g., NTQueryDirectoryFile).
    - **Call Function:** Trigger malicious function on system function calls.
    - **Pass Control:** Invoke original function for results.
    - **Alter & Return Results:** Modify results (e.g., hide a file) before returning.

**Kernel Mode IRP Hooks:**

- **IRPs Essential:** Windows kernel uses I/O Request Packets (IRPs) for data transmission.
- **Universal Application:** IRPs are used by various components, such as network interfaces and drivers.
- **DKOM Technique:** Direct Kernel Object Manipulation (DKOM) involves global hooking of function pointers in device objects.
- **Systemwide Impact:** DKOM techniques globally affect the system, allowing for fundamental manipulation.

**Userland Rootkits:**

- **IAT Hooks:** Import Address Table (IAT) resolves runtime dependencies. IAT Hooking modifies the table, redirecting functions.
- **EAT Hooks:** Export Address Table (EAT) in DLLs, housing support functions for executables. EAT Hooking primarily targets DLLs and complements IAT Hooking.
- **Inline Hooking:** Directly modifies the API function by altering the initial bytes of the target function code, inserting malicious code, and redirecting the instruction pointer (EIP) to execute code from a different memory location.

**Process Hiding:**

- Employs SSDT hooking on NtOpenProcess to obscure their presence from the EPROCESS list, detaching their structure from the list and, if necessary, from PsLoadedModuleList.

**Masquerading:**

- Uses names such as svch0st or resides in common directories like C:\Windows, to blend in and avoid detection.

**Hiding Locations:**

- Malware may hide in temporary folders, temporary internet files, or program files.

**Packing / Compression:**

- Uses tools like UPX or custom ones to compress executables, reducing pattern visibility and aiding in evading detection by antivirus products.

**Recompiling:**

- Uses different compilers to alter the executable's signature, such as an MD5 hash, to evade detection by security measures relying on specific signatures.

**Obfuscation:**

- Alters code to impede analysis and reverse engineering, used by malware and legitimate software to protect functionality.

**Anti-Reversing Techniques:**

- Aim to detect analysis and mislead analysts, including identifying virtual machine environments, detecting attached debuggers, and inserting junk code for misdirection, prolonging analysis time.

**Autostart Locations:**

- Common registry locations for malware to ensure execution at startup include:
    - HKLM\Software\Microsoft\Windows\CurrentVersion\Run
    - HKCU\Software\Microsoft\Windows\CurrentVersion\Run

Tools like Sysinternals' AutoRuns can help identify these entries.

**Scheduled Tasks:**

- Malware uses at.exe and schtasks.exe to schedule execution, maintaining persistence by running at startup or specific times.
    - Example command: schtasks /create /tn "mysc" /tr C:\Users\Public\test.exe /sc ONLOGON /ru "System"

**COM Hijacking:**

- Adversaries insert malicious code into COM references, causing malware to execute instead of legitimate software.

**DLL Hijacking:**

- **Search Order Hijacking:** Exploiting DLL search order by placing malicious DLLs in directories searched first.
- **Phantom DLL Hijacking:** Using malicious DLLs named after non-existent but expected DLLs.
- **Side Loading:** Placing malicious DLLs in the WinSxS folder.

**Windows Services:**

- **Service Creation:** Creating a service to run malware at boot.
- **Service Replacement:** Replacing existing services with malware.
- **Service Recovery:** Configuring services to run malware upon failure.

These techniques help malware evade detection and maintain persistence on infected systems
